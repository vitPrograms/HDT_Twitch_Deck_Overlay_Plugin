<UserControl x:Class="TwitchDeckOverlay.UI.ImprovedOverlayView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:TwitchDeckOverlay.UI"
             xmlns:models="clr-namespace:TwitchDeckOverlay.Models"
             xmlns:ext="clr-namespace:Hearthstone_Deck_Tracker.Utility.Extensions;assembly=HearthstoneDeckTracker"
             xmlns:tooltips="clr-namespace:Hearthstone_Deck_Tracker.Controls.Tooltips;assembly=HearthstoneDeckTracker"
             mc:Ignorable="d" 
             Width="520" MinHeight="60" MaxHeight="800"
             Background="Transparent"
             Opacity="0.95"
             MouseEnter="UserControl_MouseEnter"
             MouseLeave="UserControl_MouseLeave"
             UseLayoutRounding="True"
             TextOptions.TextFormattingMode="Display"
             TextOptions.TextRenderingMode="ClearType"
             RenderOptions.ClearTypeHint="Enabled">

    <UserControl.Resources>
        <local:RarityColorConverter x:Key="RarityColorConverter"/>
        <local:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <local:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <local:PercentageConverter x:Key="PercentageConverter"/>
        
        <!-- Стиль для заголовка -->
        <Style x:Key="HeaderStyle" TargetType="Border">
            <Setter Property="Background" Value="#FF2D2D30"/>
            <Setter Property="BorderBrush" Value="#FF404040"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Padding" Value="10,8"/>
        </Style>
        
        <!-- Стиль для кнопок управління -->
        <Style x:Key="ControlButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="#FFD4D4D4"/>
            <Setter Property="Width" Value="20"/>
            <Setter Property="Height" Value="20"/>
            <Setter Property="Margin" Value="2,0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                CornerRadius="2">
                            <ContentPresenter HorizontalAlignment="Center" 
                                            VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#FF404040"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Стиль для елементів списку колод -->
        <Style x:Key="DeckItemStyle" TargetType="Border">
            <Setter Property="Background" Value="#FF252526"/>
            <Setter Property="BorderBrush" Value="#FF404040"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#FF2D2D30"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="280"/>
            <ColumnDefinition Width="230"/>
        </Grid.ColumnDefinitions>
        <Border Grid.Column="0" 
                CornerRadius="6" 
                Background="#FF1E1E1E" 
                BorderBrush="#FF404040" 
                BorderThickness="1"
                MaxHeight="600"
                VerticalAlignment="Top">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
            <Border Grid.Row="0" Style="{StaticResource HeaderStyle}"
                    x:Name="DragHandle"
                    MouseLeftButtonDown="DragHandle_MouseLeftButtonDown"
                    MouseLeftButtonUp="DragHandle_MouseLeftButtonUp"
                    MouseMove="DragHandle_MouseMove"
                    MouseEnter="Header_MouseEnter"
                    Cursor="SizeAll">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Заголовок -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="TWITCH DECKS" 
                                   FontWeight="Bold" 
                                   FontSize="14" 
                                   Foreground="#FFD4D4D4" 
                                   Margin="0,0,10,0"/>
                        <TextBlock Text="{Binding TwitchChannel, StringFormat='#{0}'}" 
                                   FontSize="12" 
                                   Foreground="#FF888888"/>
                    </StackPanel>
                    
                    <!-- Кнопки управління -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button Style="{StaticResource ControlButtonStyle}" 
                                Click="MinimizeButton_Click"
                                ToolTip="Minimize">
                            <TextBlock Text="−" FontSize="14" FontWeight="Bold"/>
                        </Button>
                        <Button Style="{StaticResource ControlButtonStyle}" 
                                Click="CloseButton_Click"
                                ToolTip="Close">
                            <TextBlock Text="×" FontSize="14" FontWeight="Bold"/>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Список колод -->
            <ScrollViewer Grid.Row="1"
                          x:Name="DeckListScrollViewer" 
                          VerticalScrollBarVisibility="Auto" 
                          HorizontalScrollBarVisibility="Disabled"
                          MaxHeight="400">
                <ItemsControl ItemsSource="{Binding Decks}" x:Name="DeckItemsControl">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type models:DeckInfo}">
                            <local:DeckItemView DataContext="{Binding}" Loaded="DeckItemView_Loaded"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- Панель деталей колоди (знизу) -->
            <Border Grid.Row="2" 
                    x:Name="DetailsPanel"
                    Background="#FF252526" 
                    BorderBrush="#FF404040" 
                    BorderThickness="0,1,0,0"
                    Padding="15"
                    Visibility="Collapsed">
                <StackPanel>
                    <!-- Заголовок з кнопкою закриття -->
                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0" 
                                   x:Name="DetailsTitle"
                                   Text="Deck Details" 
                                   FontWeight="Bold" 
                                   FontSize="16" 
                                   Foreground="#FFD4D4D4" 
                                   VerticalAlignment="Center"/>
                        
                        <Button Grid.Column="1" 
                                Style="{StaticResource ControlButtonStyle}" 
                                Click="CloseDetailsButton_Click"
                                ToolTip="Close Details">
                            <TextBlock Text="×" FontSize="14" FontWeight="Bold"/>
                        </Button>
                    </Grid>
                    
                    <!-- Основна інформація про колоду (компактно) -->
                    <Grid Margin="0,0,0,10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Перший рядок: Клас, режим і кнопки -->
                        <Grid Grid.Row="0" Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Клас і режим -->
                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                <Border Width="28" Height="28" 
                                        CornerRadius="14" 
                                        Background="#FF404040"
                                        Margin="0,0,8,0">
                                    <Grid>
                                        <Image x:Name="DetailsClassIcon" 
                                               Width="24" Height="24"
                                               Stretch="UniformToFill"
                                               HorizontalAlignment="Center" 
                                               VerticalAlignment="Center">
                                            <Image.Clip>
                                                <EllipseGeometry Center="12,12" RadiusX="12" RadiusY="12"/>
                                            </Image.Clip>
                                        </Image>
                                        <!-- Fallback текст -->
                                        <TextBlock x:Name="DetailsClassIconText"
                                                   Text="?" 
                                                   Foreground="White" 
                                                   FontWeight="Bold" 
                                                   FontSize="14"
                                                   HorizontalAlignment="Center" 
                                                   VerticalAlignment="Center"/>
                                    </Grid>
                                </Border>
                                <StackPanel VerticalAlignment="Center">
                                    <TextBlock x:Name="DetailsClass"
                                               Text="Class" 
                                               Foreground="#FFD4D4D4" 
                                               FontWeight="SemiBold" 
                                               FontSize="14"/>
                                    <TextBlock x:Name="DetailsMode"
                                               Text="Mode" 
                                               Foreground="#FF888888" 
                                               FontSize="11"/>
                                </StackPanel>
                            </StackPanel>
                            
                            <!-- Кнопки дій -->
                            <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                <Button Background="#FF0078D4" 
                                        BorderThickness="0" 
                                        Padding="8,4" 
                                        Margin="0,0,5,0"
                                        Click="CopyDeckCodeDetails_Click"
                                        ToolTip="Copy Deck Code">
                                    <TextBlock Text="Copy" Foreground="White" FontSize="11"/>
                                </Button>
                                <Button Background="#FFFF6B6B" 
                                        BorderThickness="0" 
                                        Padding="8,4" 
                                        Click="RemoveDeckDetails_Click"
                                        ToolTip="Remove Deck">
                                    <TextBlock Text="Remove" Foreground="White" FontSize="11"/>
                                </Button>
                            </StackPanel>
                        </Grid>
                        
                        <!-- Другий рядок: Статистика з іконками -->
                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,5,0,0">
                            <!-- Кількість карт -->
                            <Border Background="#FF3A3A3C" CornerRadius="2" Padding="4,2" Margin="0,0,5,0">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="🃏" FontSize="10" Margin="0,0,3,0" VerticalAlignment="Center"
                                               UseLayoutRounding="True" TextOptions.TextFormattingMode="Display"/>
                                    <TextBlock x:Name="DetailsCardCount"
                                               Text="0" 
                                               Foreground="#FFD4D4D4" FontSize="10" FontWeight="Bold"
                                               UseLayoutRounding="True" TextOptions.TextFormattingMode="Display"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Загальна вартість пилюки -->
                            <Border Background="#FF3A3A3C" CornerRadius="2" Padding="4,2" Margin="0,0,5,0">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="✨" FontSize="10" Margin="0,0,3,0" VerticalAlignment="Center"
                                               UseLayoutRounding="True" TextOptions.TextFormattingMode="Display"/>
                                    <TextBlock x:Name="DetailsTotalDustCost"
                                               Text="0" 
                                               Foreground="#FFD4D4D4" FontSize="10" FontWeight="Bold"
                                               UseLayoutRounding="True" TextOptions.TextFormattingMode="Display"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Потрібна пилюка -->
                            <Border Background="#FF4A2C2C" CornerRadius="2" Padding="4,2" BorderBrush="#FFFF6B6B" BorderThickness="1">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="✨" FontSize="10" Margin="0,0,3,0" VerticalAlignment="Center" 
                                               Foreground="#FFFF6B6B"
                                               UseLayoutRounding="True" TextOptions.TextFormattingMode="Display"/>
                                    <TextBlock x:Name="DetailsDustNeeded"
                                               Text="0" 
                                               Foreground="#FFFF6B6B" FontSize="10" FontWeight="Bold"
                                               UseLayoutRounding="True" TextOptions.TextFormattingMode="Display"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </Grid>
                    
                    <!-- Список карт з HDT стилем -->
                    <Border BorderBrush="#FF404040" 
                            BorderThickness="0,1,0,0"
                            Padding="0,10,0,0">
                        <ScrollViewer VerticalScrollBarVisibility="Auto" 
                                      HorizontalScrollBarVisibility="Disabled"
                                      MaxHeight="300">
                            <ScrollViewer.Resources>
                                <!-- Стиль для ScrollBar -->
                                <Style TargetType="ScrollBar">
                                    <Setter Property="Background" Value="#FF2D2D30"/>
                                    <Setter Property="Foreground" Value="#FF404040"/>
                                    <Setter Property="Width" Value="12"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ScrollBar">
                                                <Grid Background="{TemplateBinding Background}">
                                                    <Track Name="PART_Track" IsDirectionReversed="True">
                                                        <Track.Thumb>
                                                            <Thumb Background="#FF606060" BorderBrush="#FF808080" BorderThickness="1">
                                                                <Thumb.Style>
                                                                    <Style TargetType="Thumb">
                                                                        <Setter Property="Template">
                                                                            <Setter.Value>
                                                                                <ControlTemplate TargetType="Thumb">
                                                                                    <Border Background="{TemplateBinding Background}" 
                                                                                            BorderBrush="{TemplateBinding BorderBrush}" 
                                                                                            BorderThickness="{TemplateBinding BorderThickness}"
                                                                                            CornerRadius="6"/>
                                                                                    <ControlTemplate.Triggers>
                                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                                            <Setter Property="Background" Value="#FF808080"/>
                                                                                        </Trigger>
                                                                                        <Trigger Property="IsDragging" Value="True">
                                                                                            <Setter Property="Background" Value="#FFA0A0A0"/>
                                                                                        </Trigger>
                                                                                    </ControlTemplate.Triggers>
                                                                                </ControlTemplate>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                    </Style>
                                                                </Thumb.Style>
                                                            </Thumb>
                                                        </Track.Thumb>
                                                    </Track>
                                                </Grid>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ScrollViewer.Resources>
                            <!-- Card list moved to separate overlay -->
                        </ScrollViewer>
                    </Border>
                </StackPanel>
            </Border>
            </Grid>
        </Border>
        
        <!-- Список карт (другий стовпець) з тонким фоном -->
        <Border Grid.Column="1" 
                Margin="10,0,0,0"
                x:Name="CardListColumn"
                Visibility="Collapsed"
                VerticalAlignment="Top"
                Background="#22000000"
                CornerRadius="4"
                BorderBrush="#33404040"
                BorderThickness="1">
                <ScrollViewer VerticalScrollBarVisibility="Auto" 
                              HorizontalScrollBarVisibility="Disabled"
                              Background="Transparent">
                    <ItemsControl x:Name="DetailsCardList">
                        <ItemsControl.ItemContainerStyle>
                            <Style>
                                <Setter Property="FrameworkElement.Margin" Value="0,1,0,0" />
                            </Style>
                        </ItemsControl.ItemContainerStyle>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Rectangle Fill="{Binding Background}" Height="34" Width="217" 
                                           ToolTipService.Placement="Right"
                                           ToolTipService.InitialShowDelay="100"
                                           ext:OverlayExtensions.ToolTip="{x:Type tooltips:CardTooltip}" />
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
        </Border>
    </Grid>
</UserControl>